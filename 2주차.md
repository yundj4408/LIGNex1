# 2주차 현장실습



### 1. 최적제어

#### 1. 1 **상태방정식이란?**

상태방정식이란 회로나 각종 시스템에 대해서 미방을 세웠을때 고차 미방에 대해서 1차 미방으로 바꾸어 표현하는 것을 상태방정식이라고 할수 있다. n차 미분방정식을 n개의 1차 미분방정식으로 바꿔 행렬로 표현한것이라고 할수 있다.

 <u>상태 (State)</u>

 \- 어떤 시점(t=t0)에서의 변수를 알고, 시간이 지난 어느 시점(t >= t0)에서의 입력을 알면, 입력이 주어진 시점(t >= t0)에서 시스템의 거동을 완전히 결정할 수 있을 때, 이러한 변수(상태변수)들의 최소집합을 말한다. 



<u>상태변수 (State Variable)</u>

 \- 동적시스템의 상태변수는 동적시스템의 상태를 결정할 수 있는 최소개수의 변수들이다. 



<u>상태벡터 (State Vector)</u>

 \- 주어진 시스템의 거동을 표현하기 위해 n개의 상태변수가 필요하다면, 이 n개의 변수를 벡터 **x** 의 n개의 성분으로 생각할 수 있다. 이러한 벡터를 상태벡터(State Vector)라고 한다. 즉, 상태(State)를 벡터형태(1 x n 행렬)로 나타낸 것이다. 

ex) 3개의 상태변수가 존재한다면,

![img](https://t1.daumcdn.net/cfile/tistory/998476415C8E471D23)

n1, n2, n3는 상태변수(State Variable)이다.



<u>상태공간 (State Space)</u>

 \- 좌표축이 x1, x2, ... xn 축으로 구성된 n차원의 공간을 상태공간(State Space)이라고 한다. 하나의 상태는 상태공간에서 한 점을 의미한다. 

ex) 

\- 2차원의 상태공간에서 상태: [2, 3] --> x1축에 한 점(2), x2축에 한 점(3).

\- 4차원의 상태공간에서 상태: [3, 5, 4, 7] --> x1축에 한 점(3), x2축에 한 점(5), x3축에 한 점(4), x4축에 한 점(7).
![상태방정식](./Pictures/상태방정식.png)



![MassSpringSystem](.\Pictures\MassSpringSystem.png)
위의 그림은 mass-spring system을 나타내는 그림이다. 마찰력이 없는 바퀴가 달려있고 무게가 m인 수레는 탄성계수가 k인 스프링에 의해 벽과 연결되어 있으며 Fa의 힘으로 오른쪽 방향으로 당겨지고 있다. 수레가 움직인 거리는 x로 나타내었다. mass-spring system의 dynamics(동역학식)는 다음과 같다.

   <img src=".\Pictures\SpringFormula.png" alt="MassSpringSystem" style="zoom:50%;" />

외부힘 Fa를 제어입력 u라고 생각한다. 

   <img src="C:\Users\user\Desktop\LIG넥스원\Pictures\SpringMatrix.png" alt="image-20210712164514201" style="zoom:50%;" />
우리는 현재의 위치 및 속도 등의 상태**(x1, x2)**와 시스템의 모델**(A, B)**을 알고 있으면, 적절한 제어입력을 선택하여 다음 상태의 속도와 가속도**(x1_dot, x2_dot)**를 결정할 수 있다. 즉, 제어입력 u를 잘 선택하면 위의 mass-spring system에서의 수레의 속도 및 가속도를 결	정하여 수레를 원하는 위치로 이동시킬 수 있다는 것이다. <수레(시스템)를 원하는 위치에 가져다 놓는 것> 이것을 우리는 수레(시스템)의 위치를 제어한다고 말한다. 



#### 1.2 대표적인 제어 방법

시스템이 빠르고 정확하게 원하는 위치하도록 하는 제어 방법은 크게 Output feedback control과 State feedback control 이 있다. 

1. **Output feedback control**
   Output feedback control은 현재의 상태를 센서로 측정하고, 이를 되먹임(feedback)하여 제어하는 방법이다. 우리가 가장 많이 사용하는 PID controller가 Output feedback controller에 해당한다.

   <img src=".\Pictures\PIDFormula.png" alt="PIDFormula" style="zoom:50%;" />
   x`센서에서 측정한 현재의 상태 y(t)와 원하는 위치 r(t)와의 차이 e(t)와 e(t)를 적분 및 미분한 값에 각각 Kp, Ki, 그리고 Kd의 PID 게인을 곱하여 제어 입력으로 사용하는 방법이다. 위의 수식에서 표현된 것처럼 Output feedback control은 시스템의 모델(A, B) 없이 제어할 수 있는 장점이 있다. 시스템이 원하는 위치에 도달하면 r(t) = y(t) 이기 때문에 e(t) = 0 이 되고, 제어 입력 u(t) = 0 [e(t) = 0, 미분(e(t)) = 0, 적분(e(t)) = 0] 이 되기 때문에 시스템은 움직이지 않는다.
   
2. **State feedback control**
   State feedback control은 말 그대로 시스템의 상태를 되먹임(feedback)하여 제어하는 방법이다. 
   <img src=".\Pictures\StateFeedBackFormula.png" alt="StateFeedBackFormula" style="zoom:50%;" />

   시스템 모델(A, B)는 변하지 않는 값이기 때문에, 우리는 K를 적절히 결정해서 시스템이 어떤 속도와 가속도로 움직여야 할지 조절할 수 있다. State feedback control의 performance는 Output feedback control의 PID 게인을 어떻게 조절하는지에 따라 달라진 것처럼, K를 어떻게 조절하는지에 따라 결정된다. 하지만, Output feedback control과 비교되는 가장 큰 장점은 trial and error 방법을 이용해 K를 구하는 것이 아니라, 시스템 모델(A, B)을 이용해서 K를 결정할 수 있다는 점이다. 즉, 모델만 정확하다면 optimal 한 K를 계산할 수 있어서 게인 값을 찾는데 드는 시간을 줄일 수 있다.



#### 1.3 K gain 구하는 법

State feedback control의 장점은 모델만 정확하다면 optimal한 K를 계산할 수 있어서 게인 값을 찾는데 드는 시간을 줄일 수 있다는 것입니다. 그럼 State feedback control에서 K는 어떻게 계산할 수 있을까요? 본 포스팅에서는 optimal value를 구하는데 사용하는 Lyapunov function에 대해 알아보겠다. 



**시스템의 stability를 판정하는 방법은 다음과 같다.**

1. Solution, State transition matrix를 구해서 stability를 판별하는 방법
   - Linear dynamical system의 general solution을 구하는데 사용.

2. Eigenvalue check
   - System의 eigenvalue가 positive real part에 있으면 unstable, nagative real part에 있으면 stable.

3. Lyapunov function
   - Loss function의 미분값이 음수(-)가 되도록 설계하여 항상 Loss function의 최소값을 구하는 방법



System이 주어지면 이미 solution이 define되어 있기 때문에, 모든 solution을 그리면 시스템이 stable한지 판별할 수 있다. 하지만 모든 solution을 구하는 것은 너무 비효율적이다.  Lyapunov function은 solution을 구하지 않고 안정도를 판별할 수 있는 방법이다.


<img src="C:\Users\user\Desktop\LIG넥스원\Pictures\등고선.PNG" alt="등고선" style="zoom:50%;" />

산속에서 길을 잃었을 때, 산 아래로 내려가는 가장 직관적인 방법은 내리막길로 이동하는 것이다. 이와 마찬가지로, 줄이려고 하는 값(error 등)을 변수로 하는 Loss function을 만들고 그 미분값이 항상 음수(-)가 되도록 설계하면 시간이 지날수록 Loss function은 최소값에 도달하게 될 것이다. 즉, 모든 x에 대해서 등고선 함수의 미분값 V_dot(x) < 0 (단, x!=0)을 보일 수 있다면, 초기값이 어디에 위치하든 Loss function이 최소가 되는 게인값 K를 찾을 수 있다.